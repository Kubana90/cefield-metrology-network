name: CEFIELD CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 1 ‚Äî Lint & Format
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  lint:
    name: üîç Lint & Format (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff==0.3.0

      - name: Check code style
        run: ruff check cloud-core/ tests/ --config pyproject.toml

      - name: Check formatting
        run: ruff format --check cloud-core/ tests/ --config pyproject.toml

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 2 ‚Äî Unit Tests (Python matrix)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  unit-tests:
    name: üß™ Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: cloud-core/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r cloud-core/requirements.txt
          pip install pytest-cov pytest-asyncio

      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v --tb=short \
            --cov=cloud-core \
            --cov-report=term-missing \
            --cov-report=xml:coverage-${{ matrix.python-version }}.xml \
            --cov-fail-under=60
        env:
          PYTHONPATH: cloud-core

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-py${{ matrix.python-version }}
          path: coverage-${{ matrix.python-version }}.xml
          retention-days: 30

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 3 ‚Äî Security Scan
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  security:
    name: üîí Security Scan (bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run security scan (report all, block HIGH)
        run: |
          bandit -r cloud-core/ \
            -x cloud-core/migrations/ \
            --severity-level medium \
            --confidence-level medium \
            -f json -o bandit-report.json || true
          echo "--- Security summary ---"
          cat bandit-report.json | python3 -c "
          import sys, json
          r = json.load(sys.stdin)
          results = r.get('results', [])
          highs = [x for x in results if x['issue_severity'] == 'HIGH']
          print(f'Total issues: {len(results)}')
          print(f'HIGH severity: {len(highs)}')
          for h in highs:
              print(f'  ‚ùå {h[\"filename\"]}:{h[\"line_number\"]} ‚Äî {h[\"issue_text\"]}')
          if highs:
              sys.exit(1)
          print('\u2705 No HIGH severity issues found.')
          "

      - name: Upload bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 4 ‚Äî Docker Build (with layer cache)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  docker-build:
    name: üê≥ Docker Build (cloud-core)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('cloud-core/Dockerfile', 'cloud-core/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ./cloud-core
          dockerfile: ./cloud-core/Dockerfile
          push: false
          tags: cefield/cloud-core:ci-${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Rotate cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 5 ‚Äî Integration Tests (real stack: pgvector + FastAPI)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  integration-tests:
    name: üîó Integration Tests (Docker Compose)
    runs-on: ubuntu-latest
    needs: [unit-tests, docker-build]

    steps:
      - uses: actions/checkout@v4

      - name: Create .env (mock secrets ‚Äî no real keys in CI)
        run: |
          cat > .env <<'EOF'
          ANTHROPIC_API_KEY=sk-ant-mock-ci-key-cefield
          STRIPE_API_KEY=sk_test_mock
          STRIPE_WEBHOOK_SECRET=whsec_mock
          EOF

      - name: Start full stack (pgvector + cloud-core + edge-agent)
        run: docker compose up -d --build

      - name: Wait for API readiness (max 90s)
        run: |
          echo "Waiting for CEFIELD API on :8000..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "‚úÖ API ready after $((i * 3))s"
              break
            fi
            echo "  attempt $i/30 ‚Äî sleeping 3s..."
            sleep 3
          done
          curl -sf http://localhost:8000/health \
            || (echo "‚ùå API did not start in time" && docker compose logs cloud-core && exit 1)

      # ---- Test 1: Health Endpoint ------------------------------------------
      - name: "TEST 1/6 ‚Äî Health endpoint returns v3.0.0"
        run: |
          RESPONSE=$(curl -sf http://localhost:8000/health)
          echo "Response: $RESPONSE"
          python3 - <<'PYEOF'
          import sys, json, subprocess
          r = json.loads(subprocess.check_output(['curl','-sf','http://localhost:8000/health']))
          assert r['status'] == 'ok',      f"status: {r}"
          assert r['version'] == '3.0.0',  f"version: {r}"
          assert r['ai'] in (True, False),  f"ai flag: {r}"
          feats = r.get('features', [])
          assert 'statistical_baseline_engine' in feats, f"missing feature: {feats}"
          assert 'cross_hardware_normalization' in feats, f"missing feature: {feats}"
          print(f"\u2705 Health OK ‚Äî version {r['version']}, features: {len(feats)}")
          PYEOF

      # ---- Test 2: Ingest (warmup phase) ------------------------------------
      - name: "TEST 2/6 ‚Äî Ingest measurement (warmup, Red Pitaya)"
        run: |
          VECTOR=$(python3 -c "
          import json, math
          v = [round(math.sin(i * 0.2) * 0.4 + 0.05, 4) for i in range(128)]
          print(json.dumps(v))
          ")
          RESPONSE=$(curl -sf -X POST http://localhost:8000/api/v1/ingest \
            -H "X-CEFIELD-API-KEY: cef_dev_machine_001" \
            -H "Content-Type: application/json" \
            -d "{\"node_id\":\"ci_rp_01\",\"hardware_type\":\"red_pitaya\",\"f0\":1500000000,\"q_factor\":52000,\"signature_vector\":$VECTOR,\"lab_name\":\"CI Lab Germany\",\"lat\":49.25,\"lon\":8.97}")
          echo "Response: $RESPONSE"
          python3 - <<PYEOF
          import json
          r = json.loads('$RESPONSE')
          assert r.get('status') in ('ingested', 'alert'), f"Unexpected: {r}"
          assert r.get('node_id') == 'ci_rp_01', f"Wrong node_id: {r}"
          print(f"\u2705 Ingest OK ‚Äî status: {r['status']}")
          PYEOF

      # ---- Test 3: Node Health Endpoint ------------------------------------
      - name: "TEST 3/6 ‚Äî Node health endpoint"
        run: |
          RESPONSE=$(curl -sf \
            -H "X-CEFIELD-API-KEY: cef_dev_machine_001" \
            http://localhost:8000/api/v1/nodes/ci_rp_01/health)
          echo "Response: $RESPONSE"
          python3 - <<PYEOF
          import json
          r = json.loads('$RESPONSE')
          assert r.get('node_id') == 'ci_rp_01',     f"node_id: {r}"
          assert 'risk_level' in r,                   f"risk_level missing: {r}"
          assert r['risk_level'] in ('low','medium','high','critical'), f"invalid risk: {r}"
          assert 'baseline' in r,                     f"baseline missing: {r}"
          assert r.get('hardware_type') == 'red_pitaya', f"hw: {r}"
          print(f"\u2705 Node health OK ‚Äî risk_level: {r['risk_level']}")
          PYEOF

      # ---- Test 4: Network Stats -------------------------------------------
      - name: "TEST 4/6 ‚Äî Network stats endpoint"
        run: |
          RESPONSE=$(curl -sf \
            -H "X-CEFIELD-API-KEY: cef_dev_machine_001" \
            http://localhost:8000/api/v1/network/stats)
          echo "Response: $RESPONSE"
          python3 - <<PYEOF
          import json
          r = json.loads('$RESPONSE')
          assert 'total_measurements' in r,    f"total_measurements missing: {r}"
          assert 'total_active_nodes' in r,    f"total_active_nodes missing: {r}"
          assert r['total_measurements'] >= 1, f"Expected >=1 measurements: {r}"
          assert r['total_active_nodes'] >= 1, f"Expected >=1 nodes: {r}"
          print(f"\u2705 Network stats OK ‚Äî {r['total_measurements']} measurements, {r['total_active_nodes']} nodes")
          PYEOF

      # ---- Test 5: Anomaly Detection (critically low Q) --------------------
      - name: "TEST 5/6 ‚Äî Anomaly detection (Q-factor below critical threshold)"
        run: |
          VECTOR=$(python3 -c "import json; print(json.dumps([0.001] * 128))")
          RESPONSE=$(curl -sf -X POST http://localhost:8000/api/v1/ingest \
            -H "X-CEFIELD-API-KEY: cef_dev_machine_001" \
            -H "Content-Type: application/json" \
            -d "{\"node_id\":\"ci_anomaly_node\",\"hardware_type\":\"red_pitaya\",\"f0\":1500000000,\"q_factor\":800,\"signature_vector\":$VECTOR}")
          echo "Response: $RESPONSE"
          python3 - <<PYEOF
          import json
          r = json.loads('$RESPONSE')
          assert r.get('status') == 'alert', f"Expected alert (Q=800 < 5000 threshold): {r}"
          assert 'alert' in r,               f"alert block missing: {r}"
          assert 'ai_diagnostic' in r,       f"ai_diagnostic missing: {r}"
          print(f"\u2705 Anomaly detection OK ‚Äî alert type: {r['alert'].get('type')}")
          PYEOF

      # ---- Test 6: Auth ‚Äî invalid key returns 403 -------------------------
      - name: "TEST 6/6 ‚Äî Auth: invalid API key returns 403"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "X-CEFIELD-API-KEY: invalid_key_should_fail" \
            http://localhost:8000/api/v1/network/stats)
          [ "$STATUS" -eq 403 ] \
            && echo "‚úÖ Auth OK ‚Äî got 403 as expected" \
            || (echo "‚ùå Expected 403, got $STATUS" && exit 1)

      # ---- Cleanup ---------------------------------------------------------
      - name: Print container logs on failure
        if: failure()
        run: |
          echo "=== cloud-core logs ==="
          docker compose logs cloud-core --tail=100
          echo "=== db logs ==="
          docker compose logs db --tail=50

      - name: Teardown stack
        if: always()
        run: docker compose down -v --remove-orphans
